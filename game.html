<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swordigo — Game</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg0:#071018; --panel:#0d0d0f; --accent:#e04b4b; --muted:#dcdcdc;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg0),#000);color:var(--muted);display:flex;align-items:center;justify-content:center;padding:14px}
  .app{width:1200px;max-width:calc(100% - 24px);display:flex;gap:14px}
  .game{flex:1;background:linear-gradient(180deg,#06141a,#021018);border-radius:10px;overflow:hidden;padding:10px;box-shadow:0 10px 60px rgba(0,0,0,0.7);position:relative}
  canvas{display:block;width:100%;height:auto;border-radius:6px;background:linear-gradient(180deg,#09222b,#021018);image-rendering:pixelated}
  .panel{width:360px;background:linear-gradient(180deg,var(--glass), rgba(0,0,0,0.18));padding:12px;border-radius:10px;border:1px solid rgba(255,0,0,0.04)}
  h2{font-family:Cinzel,serif;color:#ffcfcf;margin-bottom:6px}
  .card{background:rgba(0,0,0,0.14);padding:10px;border-radius:8px;margin-bottom:10px}
  .btn{display:inline-block;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,0,0,0.12);background:transparent;color:var(--muted);cursor:pointer;margin-right:6px}
  .small{font-size:13px;color:#e6e6e6;opacity:.95}
  #log{height:140px;overflow:auto;padding:6px;background:rgba(0,0,0,0.12);border-radius:6px;font-size:13px}
  .center-note{position:absolute;left:50%;top:10px;transform:translateX(-50%);color:#ffdede;opacity:.9;font-size:13px}
  footer{position:absolute;left:12px;bottom:10px;color:#ffddd0;opacity:.6;font-size:12px}
  @media (max-width:1100px){ .app{flex-direction:column} .panel{width:100%} }
  /* loading */
  #loading{position:absolute;inset:12px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.45));display:flex;align-items:center;justify-content:center;z-index:60;flex-direction:column;gap:10px}
  .loaderBar{width:260px;height:12px;border-radius:999px;background:rgba(255,255,255,0.04);overflow:hidden}
  .loaderBar>i{display:block;height:100%;background:linear-gradient(90deg,#ffdede,var(--accent));width:0%}
  .mutedSmall{font-size:12px;color:#ffdede;opacity:.95}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,111,97,0.08);border:1px solid rgba(255,111,97,0.06);color:#ffdede;font-weight:700}
</style>
</head>
<body>
  <div class="app">
    <div class="game card">
      <div class="center-note">Level <span id="uiLevel">1</span> • Enemies: <span id="uiEnemies">0</span></div>
      <canvas id="gameCanvas" width="1024" height="576"></canvas>
      <footer>←→/A D move • ↑/W/Space jump • Z primary • X secondary • V switch • P pause</footer>

      <div id="loading">
        <div style="font-family:Cinzel,serif;color:#ffdede;font-size:20px">Loading assets…</div>
        <div class="loaderBar"><i id="loaderFill"></i></div>
        <div class="mutedSmall" id="loaderText">0 / 0</div>
      </div>
    </div>

    <div class="panel">
      <h2>Swordigo — Adventure</h2>

      <div class="card">
        <div class="small">Player: <strong id="uiName">Guest</strong> <span id="adminBadge"></span></div>
        <div class="small">Class: <strong id="uiClass">Swordmaster</strong></div>
        <div style="margin-top:8px">
          <div class="small">HP: <span id="uiHP">100</span> • Mana: <span id="uiMana">100</span></div>
          <div class="small">XP: <span id="uiXP">0</span> • Lvl: <span id="uiPLvl">1</span></div>
        </div>
        <div style="margin-top:8px">
          <button id="btnSave" class="btn">Save</button>
          <button id="btnLoad" class="btn">Load</button>
          <button id="btnSignOut" class="btn">Sign Out</button>
        </div>
      </div>

      <div class="card">
        <div class="small">Inventory</div>
        <div class="small">Coins: <span id="uiCoins">0</span> • Potions: <span id="uiPots">0</span></div>
      </div>

      <div class="card">
        <div class="small">High Scores</div>
        <ol id="scores" class="small"></ol>
      </div>

      <div class="card">
        <div class="small">Log</div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* ---------------- Config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBF-h6Ka-jU8Cd3xpaHTT-UtNBO3aDQWZU",
  authDomain: "rpg-game-ff3f9.firebaseapp.com",
  databaseURL: "https://rpg-game-ff3f9-default-rtdb.firebaseio.com",
  projectId: "rpg-game-ff3f9",
  storageBucket: "rpg-game-ff3f9.firebasestorage.app",
  messagingSenderId: "212932693152",
  appId: "1:212932693152:web:dbdeef096a87a7c1de0dc5",
  measurementId: "G-JLX6YH0YFY"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ---------------- DOM ---------------- */
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
const loading = document.getElementById('loading'), loaderFill = document.getElementById('loaderFill'), loaderText = document.getElementById('loaderText');
const uiLevel = document.getElementById('uiLevel'), uiEnemies = document.getElementById('uiEnemies');
const uiName = document.getElementById('uiName'), uiClass = document.getElementById('uiClass');
const uiHP = document.getElementById('uiHP'), uiMana = document.getElementById('uiMana');
const uiXP = document.getElementById('uiXP'), uiPLvl = document.getElementById('uiPLvl');
const uiCoins = document.getElementById('uiCoins'), uiPots = document.getElementById('uiPots');
const scoresEl = document.getElementById('scores'), logEl = document.getElementById('log');
const btnSave = document.getElementById('btnSave'), btnLoad = document.getElementById('btnLoad'), btnSignOut = document.getElementById('btnSignOut');
const adminBadge = document.getElementById('adminBadge');

function log(s){ const e = document.createElement('div'); e.textContent = '['+new Date().toLocaleTimeString()+'] '+s; logEl.prepend(e); }

/* ---------------- Utilities ---------------- */
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function now(){ return performance.now()/1000; }
function rectOverlap(a,b){ return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h); }

/* ---------------- Assets (OpenGameArt links) ----------------
   These are example OpenGameArt files — if any fail we fallback to simple shapes.
*/
const ASSET_URLS = {
  playerSword: 'https://opengameart.org/sites/default/files/warrior_m.png',
  playerMage:  'https://opengameart.org/sites/default/files/animated-mage_0.png',
  tileGrass:   'https://opengameart.org/sites/default/files/grass_7.png',
  enemyA:      'https://opengameart.org/sites/default/files/zombie.png',
  enemyB:      'https://opengameart.org/sites/default/files/monster3.png',
  enemyC:      'https://opengameart.org/sites/default/files/bat.png',
  boss:        'https://opengameart.org/sites/default/files/boss_0.png',
  coin:        'https://opengameart.org/sites/default/files/coin_gold.png',
  potion:      'https://opengameart.org/sites/default/files/potion_red.png'
};
const IMGS = {}; let loaded = 0, tot = Object.keys(ASSET_URLS).length;
function preload(cb){
  loaderText.textContent = `0 / ${tot}`;
  for(const k in ASSET_URLS){
    const img = new Image(); img.crossOrigin='anonymous';
    img.onload = ()=>{ IMGS[k]=img; loaded++; loaderFill.style.width = Math.round((loaded/tot)*100)+'%'; loaderText.textContent = `${loaded} / ${tot}`; if(loaded===tot) setTimeout(()=>{ loading.style.display='none'; cb(); },180); };
    img.onerror = ()=>{ IMGS[k]=null; loaded++; loaderFill.style.width = Math.round((loaded/tot)*100)+'%'; loaderText.textContent = `${loaded} / ${tot}`; if(loaded===tot) setTimeout(()=>{ loading.style.display='none'; cb(); },180); };
    img.src = ASSET_URLS[k];
  }
}

/* ---------------- Game state ---------------- */
const W = canvas.width, H = canvas.height, TILE = 32;
const MAX_LEVELS = 100, BOSS_EVERY = 10;
const ADMIN_EMAIL = 'projectmoon0001i@gmail.com'.toLowerCase();

const player = {
  name:'Guest', class:'sword',
  x:120,y:H-TILE*3,w:28,h:36,vx:0,vy:0,facing:1,
  speed:220,jump:420,
  hp:100,maxHp:100,mana:100,maxMana:100,
  xp:0,lvl:1,coins:0,pots:0,
  atkCD:0,dashCD:0
};

const keys = {}; window.addEventListener('keydown', e=>{ keys[e.key.toLowerCase()] = true; if(e.key.toLowerCase()==='v') toggleClass(); if(e.key.toLowerCase()==='p') paused = !paused; });
window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });

/* ---------------- Procedural maps w/ islands & areas ---------------- */
const maps = [];
function generateMaps(){
  for(let L=1; L<=MAX_LEVELS; L++){
    const wTiles = clamp(30 + Math.floor(L*0.6), 30, 180);
    const tiles = [];
    for(let i=0;i<wTiles;i++) tiles.push({x:i*TILE, y:H-TILE, w:TILE, h:TILE, areaId:0});
    const islands = [];
    const islandCount = clamp(2 + Math.floor(L/12), 2, 14);
    for(let i=0;i<islandCount;i++){
      const ix = rand(6, wTiles-6)*TILE;
      const iy = rand(4, 12)*TILE;
      const iw = rand(2,6)*TILE;
      tiles.push({x:ix, y:iy, w:iw, h:TILE, areaId:i+1});
      islands.push({id:i+1, x:ix, y:iy, w:iw, h:TILE, minX: ix - TILE*2, maxX: ix + iw + TILE*2});
    }
    const enemies = []; const baseCount = clamp(3 + Math.floor(L/3), 3, 60);
    for(let e=0;e<baseCount;e++){
      const useIsland = Math.random() < 0.4 && islands.length>0;
      const area = useIsland ? islands[rand(0,islands.length-1)] : {id:0, x:rand(6,wTiles-4)*TILE, y:H-TILE*3};
      const ex = (area.id===0) ? rand(6,wTiles-4)*TILE : rand(area.x, area.x + Math.max(1, area.w - TILE));
      const ey = (area.id===0) ? H - TILE*2 - rand(0,120) : area.y - 28;
      let t = 'basic'; const r = Math.random();
      if(L >= 70 && r < 0.12) t = 'ranged';
      else if(L >= 40 && r < 0.20) t = 'fast';
      else if(L >= 20 && r < 0.12) t = 'tank';
      else if(r < 0.06) t = 'ghost';
      enemies.push({x:ex,y:ey,type:t,areaId:area.id,patrolMin:area.id===0?ex-TILE*6:area.minX,patrolMax:area.id===0?ex+TILE*6:area.maxX});
    }
    const pickups = [];
    for(let k=0;k<clamp(3 + Math.floor(L/10),3,20);k++){
      pickups.push({x:rand(6,wTiles-4)*TILE, y:H - TILE*2 - rand(0,120), type: Math.random()<0.85?'coin':'potion', areaId:0});
    }
    const boss = (L % BOSS_EVERY === 0) ? {x:(wTiles-10)*TILE, y:H - TILE*4 - 40, type:'boss', hp: 200 + L*40, areaId:0} : null;
    const exit = {x:(wTiles-2)*TILE, y:H-TILE-64};
    maps.push({L,wTiles,tiles,islands,enemies,pickups,boss,exit});
  }
}
generateMaps();

/* ---------------- Runtime ---------------- */
let ents = [], pickups = [], projectiles = [], particles = [];
let currentLevel = 1;
let paused = false;

/* helper spawn */
function spawnEnemy(t){
  const baseHP = t.type==='tank'?120: t.type==='boss'? (t.hp||400) : t.type==='ghost'?35:45;
  const speed = t.type==='fast'?90: t.type==='boss'?60:45;
  const w = t.type==='boss'?64:28, h = t.type==='boss'?64:28;
  const minX = t.patrolMin!==undefined? t.patrolMin : (t.areaId? t.x - TILE*2 : t.x - TILE*6);
  const maxX = t.patrolMax!==undefined? t.patrolMax : (t.areaId? t.x + TILE*2 + TILE : t.x + TILE*6);
  return {x:t.x,y:t.y,w,h,type:t.type,hp:baseHP,vx:speed,dir:Math.random()<0.5?-1:1,timer:0,areaId:t.areaId,minX,maxX};
}

/* load level */
function loadLevel(n){
  currentLevel = clamp(n,1,MAX_LEVELS);
  const m = maps[currentLevel-1];
  ents = m.enemies.map(e=>spawnEnemy(e));
  if(m.boss) ents.push(spawnEnemy(m.boss));
  pickups = m.pickups.map(p=>Object.assign({},p));
  projectiles = []; particles = [];
  player.x = 120; player.y = H - TILE*3; player.vx=0; player.vy=0;
  log('Loaded Level '+currentLevel + (m.boss ? ' (Boss)' : ''));
  updateUI();
}
loadLevel(1);

/* abilities */
function toggleClass(){ player.class = (player.class==='sword')?'mage':'sword'; uiClass.textContent = (player.class==='sword')?'Swordmaster':'Mage'; log('Switched to '+uiClass.textContent); }
function swordAttack(){ if(player.atkCD>0) return; player.atkCD=0.36; const hx = player.x + (player.facing>0? player.w : -40); projectiles.push({x:hx,y:player.y+8,w:40,h:24,life:0.12,dmg:28,source:'sword'}); for(let i=0;i<8;i++) particles.push({x:hx+rand(-6,6),y:player.y+8+rand(-8,8),vx:rand(-40,40),vy:rand(-120,-20),life:0.45,col:'rgba(255,160,120,0.95)'}); }
function mageBolt(){ if(player.atkCD>0 || player.mana<10) return; player.atkCD=0.18; player.mana-=10; const vx = player.facing * 420; projectiles.push({x:player.x+player.w/2,y:player.y+12,w:12,h:12,life:2.4,vx:vx,vy:0,dmg:18,source:'mage'}); }
function mageBurst(){ if(player.atkCD>0 || player.mana<40) return; player.atkCD=0.6; player.mana-=40; const n=12; for(let i=0;i<n;i++){ const ang=(Math.PI*2)*(i/n); projectiles.push({x:player.x+player.w/2,y:player.y+player.h/2,w:8,h:8,life:1.2,vx:Math.cos(ang)*260,vy:Math.sin(ang)*260,dmg:14,source:'mage'}); } for(let i=0;i<36;i++) particles.push({x:player.x+player.w/2+rand(-10,10),y:player.y+player.h/2+rand(-10,10),vx:rand(-160,160),vy:rand(-200,-10),life:0.8,col:'rgba(180,120,255,0.9)'}); }
function dash(){ if(player.dashCD>0) return; player.dashCD=0.9; player.vx = player.facing * 520; for(let i=0;i<6;i++) particles.push({x:player.x+rand(-6,6),y:player.y+rand(-6,6),vx:-player.facing*rand(40,140),vy:rand(-20,20),life:0.3,col:'rgba(255,190,120,0.9)'}); }
function interact(){ const m=maps[currentLevel-1]; if(player.x > m.exit.x - 80){ if(m.boss && ents.find(e=>e.type==='boss')){ log('Defeat the boss'); return; } if(currentLevel < MAX_LEVELS) loadLevel(currentLevel+1); else log('Final level reached'); } }

/* input action keys */
window.addEventListener('keydown',(e)=>{
  const k = e.key.toLowerCase();
  if(k==='z'){ if(player.class==='sword') swordAttack(); else mageBolt(); }
  if(k==='x'){ if(player.class==='sword') dash(); else mageBurst(); }
  if(k==='c'){ interact(); }
});

/* physics & update */
function update(dt){
  if(paused) return;
  // admin infinite stats
  const isAdmin = currentUser && currentUser.email && currentUser.email.toLowerCase() === ADMIN_EMAIL;
  if(isAdmin){
    player.hp = player.maxHp = 999999;
    player.mana = player.maxMana = 999999;
    player.coins = 9999999;
    player.xp = 9999999;
    player.atkCD = 0; player.dashCD = 0;
  } else {
    player.mana = clamp(player.mana + 25*dt, 0, player.maxMana);
  }

  // movement input
  const left = keys['arrowleft']||keys['a'], right = keys['arrowright']||keys['d'];
  const upKey = keys['arrowup']||keys['w']||keys[' '];
  if(left){ player.vx = -player.speed; player.facing = -1; } else if(right){ player.vx = player.speed; player.facing = 1; } else { player.vx = player.vx * 0.8; if(Math.abs(player.vx) < 5) player.vx = 0; }
  if(upKey && player.onGround){ player.vy = -player.jump; player.onGround = false; }

  player.vy += 1400 * dt;
  player.atkCD = Math.max(0, player.atkCD - dt);
  player.dashCD = Math.max(0, player.dashCD - dt);
  player.x += player.vx * dt;
  player.y += player.vy * dt;

  const m = maps[currentLevel-1];
  // collisions with tiles
  player.onGround = false;
  for(const t of m.tiles){
    if(rectOverlap(player, t)){
      if(player.vy > 0 && (player.y + player.h) - t.y < 34){
        player.y = t.y - player.h; player.vy = 0; player.onGround = true;
      } else if(player.vy < 0){
        player.vy = 0; player.y = t.y + t.h + 0.1;
      } else {
        if(player.x < t.x) player.x = t.x - player.w - 0.1; else player.x = t.x + t.w + 0.1;
        player.vx = 0;
      }
    }
  }

  const levelWidthPx = m.wTiles * TILE;
  player.x = clamp(player.x, 8, levelWidthPx - player.w - 8);
  player.y = clamp(player.y, -400, H - player.h + 80);

  // pickups
  for(let i=pickups.length-1;i>=0;i--){
    const p = pickups[i];
    if(rectOverlap(player, {x:p.x,y:p.y,w:24,h:24})){
      if(p.type==='coin'){ player.coins++; player.xp += 5; }
      else { player.pots++; player.hp = clamp(player.hp + 40, 0, player.maxHp); }
      pickups.splice(i,1); log('Picked up '+p.type);
    }
  }

  // projectiles
  for(let i=projectiles.length-1;i>=0;i--){
    const pr = projectiles[i];
    if(pr.vx) pr.x += pr.vx * dt;
    if(pr.vy) pr.y += pr.vy * dt;
    pr.life -= dt;
    if(pr.life <= 0){ projectiles.splice(i,1); continue; }
    for(let j=ents.length-1;j>=0;j--){
      const en = ents[j];
      if(rectOverlap(pr, {x:en.x,y:en.y,w:en.w,h:en.h})){
        en.hp -= pr.dmg || 20;
        for(let k=0;k<6;k++) particles.push({x:pr.x+rand(-6,6),y:pr.y+rand(-6,6),vx:rand(-80,80),vy:rand(-80,80),life:0.4,col:'rgba(255,200,120,0.95)'});
        projectiles.splice(i,1);
        if(en.hp <= 0){
          player.xp += (en.type==='boss'? 300 : 12 + Math.floor(currentLevel/4));
          player.coins += en.type==='boss'? 15 : 2 + rand(0,2);
          if(Math.random() < 0.45) pickups.push({x:en.x, y:en.y, type:'coin'});
          ents.splice(j,1);
        }
        break;
      }
    }
  }

  // enemies AI (area-limited)
  for(const en of ents){
    en.timer = (en.timer||0) + dt;
    const areaActive = (en.areaId === 0) || (Math.abs(player.x - en.x) < canvas.width * 0.9 && player.y < en.y + TILE*4);
    if(!areaActive) continue;

    if(en.type === 'basic'){
      const dir = (player.x > en.x) ? 1 : -1; en.x += dir * en.vx * dt; if(rectOverlap(player,en)) player.hp -= 20 * dt;
    } else if(en.type === 'fast'){
      const dir = (player.x > en.x) ? 1 : -1; en.x += dir * (en.vx*1.6) * dt; if(rectOverlap(player,en)) player.hp -= 28 * dt;
    } else if(en.type === 'ranged'){
      if(en.timer > 1.2){ en.timer = 0; const dx = player.x - en.x, dy = player.y - en.y; const mag = Math.hypot(dx,dy)||1; const vx = (dx/mag) * 160, vy = (dy/mag) * 160; projectiles.push({x:en.x, y:en.y+6, w:10, h:10, vx:vx, vy:vy, life:3.0, dmg:14, source:'enemy'}); }
    } else if(en.type === 'tank'){
      const dir = (player.x > en.x) ? 1 : -1; en.x += dir * (en.vx*0.6) * dt; if(rectOverlap(player,en)) player.hp -= 40 * dt;
    } else if(en.type === 'ghost'){
      const dir = (player.x > en.x) ? 1 : -1; en.x += dir * (en.vx*1.1) * dt; en.y += Math.sin(now()+en.x)*6*dt; if(rectOverlap(player,en)) player.hp -= 18 * dt;
    } else if(en.type === 'boss'){
      if(en.timer > 2.5){ en.timer = 0; for(let a=0;a<14;a++){ const ang = a*(Math.PI*2/14); projectiles.push({x:en.x+en.w/2, y:en.y+en.h/2, w:10, h:10, vx:Math.cos(ang)*160, vy:Math.sin(ang)*160, life:2.4, dmg:26, source:'boss'}); } }
      const dir = (player.x > en.x) ? 1 : -1; en.x += dir * (en.vx*0.5) * dt; if(rectOverlap(player,en)) player.hp -= 60 * dt;
    }
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){ const p = particles[i]; p.x += (p.vx||0)*dt; p.y += (p.vy||0)*dt; p.vy += 300*dt; p.life -= dt; if(p.life<=0) particles.splice(i,1); }

  // occasional spawns
  const m2 = maps[currentLevel-1];
  if(!m2.boss && ents.length < Math.max(3, Math.floor(m2.enemies.length/4)) && Math.random() < 0.01){
    ents.push(spawnEnemy({x: rand(8,m2.wTiles-3)*TILE, y: H - TILE*3, type: ['basic','fast','ranged','tank','ghost'][rand(0,4)], areaId:0, patrolMin:null, patrolMax:null}));
  }

  // exit check
  if(player.x > m.exit.x){
    if(m.boss && ents.find(e=>e.type==='boss')){ /* require boss defeat */ }
    else if(currentLevel < MAX_LEVELS) loadLevel(currentLevel+1);
  }

  // death
  const isAdmin = currentUser && currentUser.email && currentUser.email.toLowerCase() === ADMIN_EMAIL;
  if(player.hp <= 0 && !isAdmin){
    log('You died on Level '+currentLevel);
    submitScore();
    player.hp = player.maxHp; player.xp = Math.max(0, player.xp - 20); player.coins = Math.max(0, player.coins - 5);
    loadLevel(currentLevel);
  }

  updateUI();
}

/* ---------------- draw ---------------- */
function draw(){
  ctx.clearRect(0,0,W,H);
  const m = maps[currentLevel-1];
  // sky gradient
  const g = ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0b2731'); g.addColorStop(1,'#021018'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  // parallax
  ctx.fillStyle='rgba(0,20,30,0.6)'; for(let i=0;i<6;i++){ const px = ((i*300) - ((player.x/4) % 300)); ctx.fillRect(px, 60 + i*6, 260, 80); }

  const camX = clamp(player.x - (W/2 - 140), 0, Math.max(0, m.wTiles * TILE - W));

  // tiles / islands
  for(const t of m.tiles){
    const dx = t.x - camX; if(dx + t.w < -120 || dx > W+120) continue;
    if(IMGS.tileGrass && IMGS.tileGrass.complete) ctx.drawImage(IMGS.tileGrass,0,0,32,32,dx,t.y,t.w,t.h);
    else { ctx.fillStyle = (t.areaId===0? '#274B2F' : '#2b3b2e'); ctx.fillRect(dx,t.y,t.w,t.h); }
  }

  // islands shadows
  for(const isl of m.islands || []){ const dx = isl.x - camX; ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fillRect(dx, isl.y + isl.h, isl.w, 6); }

  // pickups
  for(const p of pickups){
    const dx = p.x - camX; if(dx < -50 || dx > W+50) continue;
    const img = p.type==='coin' ? IMGS.coin : IMGS.potion;
    if(img && img.complete) ctx.drawImage(img, dx, p.y, 24, 24);
    else { ctx.fillStyle = p.type==='coin' ? '#ffd24a' : '#ff4b8b'; ctx.fillRect(dx,p.y,18,18); }
  }

  // enemies
  for(const e of ents){
    const dx = e.x - camX; if(dx < -200 || dx > W+200) continue;
    if(e.type==='boss'){ if(IMGS.boss && IMGS.boss.complete) ctx.drawImage(IMGS.boss,dx,e.y,e.w*2,e.h*2); else { ctx.fillStyle='#aa4444'; ctx.fillRect(dx,e.y,e.w*2,e.h*2); } }
    else {
      const img = (e.type==='fast'||e.type==='tank')? IMGS.enemyB : (e.type==='ghost'?IMGS.enemyC:IMGS.enemyA);
      if(img && img.complete) ctx.drawImage(img,dx,e.y,e.w,e.h); else { ctx.fillStyle='#994444'; ctx.fillRect(dx,e.y,e.w,e.h); }
    }
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(dx,e.y-8,e.w,6);
    ctx.fillStyle='rgba(255,80,80,0.9)'; ctx.fillRect(dx, e.y-8, clamp((e.hp/(e.type==='boss'? (e.hp||300) : 60))*e.w, 0, e.w), 6);
  }

  // player
  const px = player.x - camX;
  const pimg = (player.class==='mage')? IMGS.playerMage : IMGS.playerSword;
  if(pimg && pimg.complete){ ctx.save(); ctx.translate(px + player.w/2, player.y + player.h/2); if(player.facing<0) ctx.scale(-1,1); ctx.drawImage(pimg, -player.w/2, -player.h/2, player.w, player.h); ctx.restore(); }
  else { ctx.fillStyle='#ffdede'; ctx.fillRect(px, player.y, player.w, player.h); }

  // projectiles
  for(const pr of projectiles){ const dx = pr.x - camX; ctx.fillStyle = pr.source==='mage' ? 'rgba(150,180,255,0.95)' : (pr.source==='enemy'||pr.source==='boss') ? 'rgba(255,140,120,0.95)': 'rgba(255,210,160,0.95)'; ctx.fillRect(dx, pr.y, pr.w, pr.h); }

  // particles
  for(const p of particles){ ctx.fillStyle = p.col || 'rgba(255,255,255,0.9)'; ctx.fillRect(p.x - camX, p.y, 3, 3); }

  // HUD
  ctx.fillStyle='rgba(0,0,0,0.38)'; ctx.fillRect(8, H-56, 640, 40);
  ctx.fillStyle='#ffdede'; ctx.font='14px Inter, sans-serif';
  ctx.fillText(`Level ${currentLevel}  HP:${Math.round(player.hp)}  Mana:${Math.round(player.mana)}  XP:${Math.round(player.xp)}  Coins:${player.coins}`, 20, H-30);
}

/* ----- game loop ----- */
let lastT = now();
function loop(){
  const t = now(); let dt = t - lastT; lastT = t; if(dt>0.06) dt=0.06;
  update(dt); draw();
  uiLevel.textContent = currentLevel; uiEnemies.textContent = ents.length;
  requestAnimationFrame(loop);
}

/* ---------------- Firebase auth & DB ---------------- */
let currentUser = null;
auth.onAuthStateChanged(u=>{
  currentUser = u;
  if(u){
    uiName.textContent = u.displayName || u.email || ('User-'+u.uid.slice(0,6));
    log('Signed in: '+uiName.textContent + (u.email?(' ('+u.email+')'):''));
    if(u.email && u.email.toLowerCase() === ADMIN_EMAIL){ adminBadge.innerHTML = '<span class="badge">ADMIN</span>'; log('Admin enabled'); }
    else adminBadge.innerHTML = '';
    // try loading player record automatically (if exists)
    db.ref('players/'+u.uid).once('value').then(snap=>{
      const v = snap.val();
      if(v){
        player.class = v.class || player.class; player.hp = v.hp || player.hp; player.mana = v.mana || player.mana;
        player.xp = v.xp || player.xp; player.lvl = v.lvl || player.lvl; player.coins = v.coins || player.coins; player.pots = v.pots || player.pots;
        loadLevel(v.level || 1); if(v.x) player.x = v.x; if(v.y) player.y = v.y;
        updateUI(); log('Player data loaded from DB.');
      } else {
        // create record
        const isAdmin = (u.email && u.email.toLowerCase() === ADMIN_EMAIL);
        const initial = { name: u.displayName || 'Player', email: u.email || null, class: player.class, hp: isAdmin ? 999999 : player.hp, mana: isAdmin ? 999999 : player.mana, xp: player.xp, lvl: player.lvl, coins: player.coins, pots: player.pots, level: currentLevel, createdAt: Date.now() };
        db.ref('players/'+u.uid).set(initial).then(()=>log('Created player record'));
      }
    }).catch(e=>log('DB load error: '+e.message));
    loadScores();
  } else {
    uiName.textContent = 'Guest';
    adminBadge.innerHTML = '';
    log('Not signed in — sign in to save progress.');
  }
});

/* buttons */
btnSave.addEventListener('click', ()=> savePlayer(true));
btnLoad.addEventListener('click', ()=> loadPlayer());
btnSignOut.addEventListener('click', ()=> { auth.signOut().then(()=>{ window.location.href = 'index.html'; }); });

function savePlayer(showLog){
  if(!currentUser){ log('Sign in to save'); return; }
  const payload = { name: uiName.textContent, class: player.class, hp: Math.round(player.hp), mana: Math.round(player.mana), xp: player.xp, lvl: player.lvl, coins: player.coins, pots: player.pots, level: currentLevel, x: Math.round(player.x), y: Math.round(player.y), ts: Date.now() };
  db.ref('players/'+currentUser.uid).set(payload).then(()=>{ if(showLog) log('Saved progress'); }).catch(e=>log('Save error: '+e.message));
}
function loadPlayer(){
  if(!currentUser){ log('Sign in to load'); return; }
  db.ref('players/'+currentUser.uid).once('value').then(snap=>{
    const v = snap.val(); if(!v){ log('No saved data'); return; }
    player.class = v.class || player.class; player.hp = v.hp || player.hp; player.mana = v.mana || player.mana; player.xp = v.xp || player.xp; player.lvl = v.lvl || player.lvl; player.coins = v.coins || player.coins; player.pots = v.pots || player.pots;
    loadLevel(v.level || 1); if(v.x) player.x = v.x; if(v.y) player.y = v.y; uiClass.textContent = (player.class==='sword') ? 'Swordmaster' : 'Mage';
    log('Progress loaded');
  }).catch(e=>log('Load error: '+e.message));
}

/* high scores */
function submitScore(){
  if(!currentUser) return;
  const entry = { name: uiName.textContent, score: Math.round(player.xp), ts: Date.now() };
  db.ref('scores').push(entry).then(()=>loadScores()).catch(e=>log('Score push error'));
}
function loadScores(){
  scoresEl.innerHTML = '<li>loading...</li>';
  db.ref('scores').orderByChild('score').limitToLast(10).once('value').then(snap=>{
    const arr=[]; snap.forEach(s=>arr.push(s.val())); arr.sort((a,b)=>b.score-a.score); scoresEl.innerHTML=''; arr.forEach(a=>{ const li=document.createElement('li'); li.textContent = (a.name||'Anon')+': '+a.score; scoresEl.appendChild(li); });
    if(arr.length===0) scoresEl.innerHTML = '<li>No scores</li>';
  }).catch(e=>{ scoresEl.innerHTML = '<li>failed</li>'; console.warn(e); });
}

/* update UI */
function updateUI(){
  uiHP.textContent = Math.round(player.hp);
  uiMana.textContent = Math.round(player.mana);
  uiXP.textContent = Math.round(player.xp);
  uiPLvl.textContent = player.lvl;
  uiCoins.textContent = player.coins;
  uiPots.textContent = player.pots;
  uiClass.textContent = (player.class==='sword') ? 'Swordmaster' : 'Mage';
}

/* debug */
window.addEventListener('keydown', e=>{ if(e.key==='F8'){ player.xp += 100; updateUI(); log('Debug +100 XP'); } });

/* preload assets & start */
preload(()=>{
  // ensure bosses exist
  for(let L=1; L<=MAX_LEVELS; L++){
    if(L % BOSS_EVERY === 0){
      const m = maps[L-1];
      m.enemies = [{x:(m.wTiles-8)*TILE, y:H - TILE*4 - 40, type:'boss', hp: 200 + L*50, areaId:0}];
    }
  }
  loading.style.display = 'none';
  lastT = now();
  loop();
  log('Game ready — press V to switch class. Sign in to save progress.');
});

/* save on unload */
window.addEventListener('beforeunload', ()=>{ if(currentUser) savePlayer(false); });

</script>
</body>
</html>
