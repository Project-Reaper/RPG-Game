<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swordigo — Sign In</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071018;
    --panel:#071827;
    --accent:#e04b4b;
    --muted:#e8eef6;
    --glass: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg),#020409);color:var(--muted)}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{width:1000px;max-width:calc(100% - 32px);display:flex;gap:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.14));border-radius:14px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,0.6);border:1px solid rgba(255,111,97,0.06)}
  .left{flex:1;padding:12px}
  .right{width:360px;padding:12px;border-left:1px solid rgba(255,255,255,0.03)}
  h1{font-family:Cinzel,serif;font-size:28px;margin:0 0 6px 0;color:#ffdede}
  p{color:#cfe6f2;margin-top:6px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#b73a3a);border:0;color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(224,75,75,0.12)}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
  .small{font-size:13px;color:#cfe6f2}
  .note{margin-top:12px;color:#a7cbd8}
  ul{color:#cfe6f2;margin-left:18px}
  .footer{margin-top:18px;color:#9fb8c6;font-size:13px}
  .logo { width:120px; height:120px; border-radius:12px; background:linear-gradient(135deg,#1b2f3b,#05222a); display:flex;align-items:center;justify-content:center; font-family:Cinzel, serif; font-size:20px; color:#ffdede; box-shadow: 0 8px 30px rgba(0,0,0,0.6); }
  .status { margin-top:12px; font-size:13px; color:#cfe6f2; }
  @media (max-width:900px){ .card{flex-direction:column} .right{width:100%;border-left:0;border-top:1px solid rgba(255,255,255,0.02)} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="left">
        <div style="display:flex;gap:16px;align-items:center">
          <div class="logo">Swordigo</div>
          <div>
            <h1>Swordigo — Mage & Swordmaster</h1>
            <div class="small">Sign in to save progress, load your stats, and compete on high scores. Admin account gets infinite stats in-game.</div>
          </div>
        </div>

        <div style="margin-top:18px;">
          <button id="btnGoogle" class="btn">Sign in with Google</button>
          <button id="btnAnon" class="btn secondary" style="margin-left:10px">Play Anonymously</button>
        </div>

        <div class="note">After signing in you'll be redirected to the game page. If the popup fails or is blocked we use redirect-based sign-in for reliability.</div>

        <div style="margin-top:16px">
          <div class="small">Controls</div>
          <ul>
            <li>← → / A D = Move</li>
            <li>↑ / W / Space = Jump</li>
            <li>Z = Primary (Sword slash / Fireball)</li>
            <li>X = Secondary (Dash / Area Burst)</li>
            <li>V = Switch class, P = Pause</li>
          </ul>
        </div>

        <div class="footer">Run on a local server (e.g. <code>python -m http.server</code>) so Google sign-in works correctly.</div>
      </div>

      <div class="right">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700;color:#ffdede">Account</div>
            <div id="status" class="status">Not signed in</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700;color:#ffdede">Admin</div>
            <div style="color:#cfe6f2;font-size:13px">projectmoon0001i@gmail.com</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700;color:#ffdede">Troubleshooting</div>
          <div class="small" style="margin-top:8px">If you see "popup closed" errors, try the redirect sign-in (this page uses redirect fallback).</div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700;color:#ffdede">Local debug</div>
          <div class="small" style="margin-top:8px"><button id="btnClearLocal" class="btn secondary">Clear local saved profile</button></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBF-h6Ka-jU8Cd3xpaHTT-UtNBO3aDQWZU",
      authDomain: "rpg-game-ff3f9.firebaseapp.com",
      databaseURL: "https://rpg-game-ff3f9-default-rtdb.firebaseio.com",
      projectId: "rpg-game-ff3f9",
      storageBucket: "rpg-game-ff3f9.firebasestorage.app",
      messagingSenderId: "212932693152",
      appId: "1:212932693152:web:dbdeef096a87a7c1de0dc5",
      measurementId: "G-JLX6YH0YFY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const btnGoogle = document.getElementById('btnGoogle');
    const btnAnon = document.getElementById('btnAnon');
    const status = document.getElementById('status');
    const btnClearLocal = document.getElementById('btnClearLocal');

    // Update status text
    auth.onAuthStateChanged(u=>{
      if(u) status.textContent = `Signed in as ${u.displayName || u.email || u.uid}`;
      else status.textContent = 'Not signed in';
    });

    // Use redirect sign-in to avoid popup-block issues
    btnGoogle.addEventListener('click', ()=>{
      const provider = new firebase.auth.GoogleAuthProvider();
      // request email and profile (default)
      auth.signInWithRedirect(provider);
    });

    // Anonymous sign-in fallback
    btnAnon.addEventListener('click', ()=>{
      auth.signInAnonymously().then(()=>{ window.location.href = 'game.html'; }).catch(e=>alert('Anonymous sign-in failed: '+e.message));
    });

    // After redirect completes, handle result and forward to game page
    // This will be called when the redirect flow returns.
    auth.getRedirectResult().then(result=>{
      if(result && result.user){
        // store a lightweight profile locally so game.html can show quickly
        try{ localStorage.setItem('swordigo_user', JSON.stringify({uid: result.user.uid, name: result.user.displayName, email: result.user.email||null})); }catch(e){}
        // create an initial database record if missing
        const u = result.user;
        const pRef = firebase.database().ref('players/' + u.uid);
        pRef.once('value').then(snap=>{
          if(!snap.exists()){
            const isAdmin = (u.email && u.email.toLowerCase() === 'projectmoon0001i@gmail.com');
            pRef.set({
              name: u.displayName || 'Player',
              email: u.email || null,
              class: 'sword',
              hp: isAdmin ? 999999 : 100,
              mana: isAdmin ? 999999 : 100,
              xp: 0,
              level: 1,
              coins: 0,
              pots: 0,
              createdAt: Date.now()
            }).then(()=>{ window.location.href = 'game.html'; }).catch(()=>{ window.location.href = 'game.html'; });
          } else {
            // already there, just redirect
            window.location.href = 'game.html';
          }
        }).catch(()=>{ window.location.href = 'game.html'; });
      }
    }).catch((err)=>{
      console.warn('Redirect sign-in result error:', err);
      // still safe to continue — user can click sign in again.
    });

    btnClearLocal.addEventListener('click', ()=>{
      localStorage.removeItem('swordigo_user');
      alert('Local saved player cleared.');
    });
  </script>
</body>
</html>
